<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bloom & Thread - Track Orders</title>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
html, body { margin:0; padding:0; height:100%; font-family:'Poppins',sans-serif; }
body { display:flex; flex-direction:column; min-height:100vh; }
nav { padding:10px 20px; background: rgba(255,182,193,0.3); }
nav .logo { font-weight:bold; color:#4a2c2a; text-decoration:none; }
main { flex:1; padding:10px 0; }
h1 { text-align:center; color:#4a2c2a; margin:20px 0; }
#orders-container { width:100%; flex:1; overflow-y:auto; padding:0 10px; }
.order-status { text-align:center; color:#5e366e; font-weight:600; margin-bottom:10px; }
.order-map { width:100%; height:400px; margin-bottom:20px; border-radius:10px; }
footer { background: rgba(94,54,110,0.9); color:#fff; padding:20px 0; text-align:center; font-size:0.95rem; }
</style>
</head>
<body>

<nav>
  <a href="index.html" class="logo">Bloom & Thread</a>
</nav>

<main>
  <h1>Track Your Orders</h1>
  <div id="orders-container"></div>
</main>

<footer>
  <p>&copy; 2025 Bloom & Thread. All rights reserved.</p>
</footer>

<!-- Google Maps JS -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiGFzck2LMf-dV1peWnd8SxdzgQoNmnB4&callback=initApp">
</script>

<script>
const VALID_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjA5MDUyYzIyYzc4NDRhMTBiZjE3M2I1NGRlYmFmMTNiIiwiaCI6Im11cm11cjY0In0=';

// Get API key from URL or localStorage
const urlParams = new URLSearchParams(window.location.search);
let apiKey = urlParams.get('apiKey') || localStorage.getItem('bloom_api_key');
if (!urlParams.get('apiKey')) localStorage.setItem('bloom_api_key', apiKey);

const container = document.getElementById('orders-container');

if (apiKey !== VALID_API_KEY) {
  container.innerHTML = '<p style="text-align:center; color:red;">Invalid API Key. Cannot track orders.</p>';
} else {
  window.initApp = initApp;
}

// Initialize the app
function initApp() {
  renderOrders();
  setInterval(updateStatuses, 1000);
}

// Update order status text
function updateStatuses() {
  const orders = JSON.parse(localStorage.getItem('orders')) || [];
  document.querySelectorAll('.order-status').forEach((el, idx) => {
    if (orders[idx]) el.textContent = `Order #${idx+1} — Status: ${orders[idx].status}`;
  });
}

// Render orders with maps
function renderOrders() {
  const orders = JSON.parse(localStorage.getItem('orders')) || [];
  container.innerHTML = '';

  if (!orders.length) {
    container.innerHTML = '<p style="text-align:center; color:#5e366e;">No orders found.</p>';
    return;
  }

  orders.forEach((order, idx) => {
    // Status display
    const statusDiv = document.createElement('div');
    statusDiv.className = 'order-status';
    statusDiv.textContent = `Order #${idx+1} — Status: ${order.status}`;
    container.appendChild(statusDiv);

    // Map container
    const mapDiv = document.createElement('div');
    mapDiv.className = 'order-map';
    mapDiv.id = `map-${idx}`;
    container.appendChild(mapDiv);

    const business = { lat: 10.2980, lng: 123.8646 };
    const delivery = { lat: Number(order.delivery.lat), lng: Number(order.delivery.lng) };

    const map = new google.maps.Map(mapDiv, {
      center: business,
      zoom: 14,
      mapTypeControl: false
    });

    const directionsService = new google.maps.DirectionsService();
    const directionsRenderer = new google.maps.DirectionsRenderer({
      map: map,
      suppressMarkers: true,
      polylineOptions: { strokeColor: '#d11a2a', strokeWeight: 5 }
    });

    // AdvancedMarkerElement (recommended)
    const shopMarker = new google.maps.marker.AdvancedMarkerElement({
      position: business,
      map: map,
      title: 'Bloom & Thread - Basak Pardo, Cebu City'
    });

    const deliveryMarker = new google.maps.marker.AdvancedMarkerElement({
      position: delivery,
      map: map,
      draggable: true,
      title: 'Delivery Location'
    });

    const courierMarker = new google.maps.marker.AdvancedMarkerElement({
      position: business,
      map: map,
      label: { text: '🏍️', fontSize: '24px' }
    });

    directionsService.route({
      origin: business,
      destination: delivery,
      travelMode: google.maps.TravelMode.DRIVING
    }, (result, status) => {
      if (status === 'OK') {
        directionsRenderer.setDirections(result);
        animateCourier(result.routes[0].overview_path, courierMarker, order);
      }
    });

    function animateCourier(route, marker, order) {
      if (!['On the Way', 'Out for Delivery'].includes(order.status)) return;
      let i = 0;
      const interval = setInterval(() => {
        if (i >= route.length || !['On the Way', 'Out for Delivery'].includes(order.status)) {
          clearInterval(interval);
          return;
        }
        marker.position = route[i];
        i++;
      }, 200);
    }

    // Watch for status changes
    const watcher = setInterval(() => {
      const updatedOrders = JSON.parse(localStorage.getItem('orders')) || [];
      if (!updatedOrders[idx]) { clearInterval(watcher); return; }
      if (order.status !== updatedOrders[idx].status) {
        order.status = updatedOrders[idx].status;
        statusDiv.textContent = `Order #${idx+1} — Status: ${order.status}`;
      }
    }, 1000);
  });
}
</script>
</body>
</html>
